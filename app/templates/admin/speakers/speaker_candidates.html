<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="stylesheet" href="{{ url_for('static', filename='assets/bootstrap/dist/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/font-awesome/css/font-awesome.min.css') }}">

    <link rel="stylesheet" href="{{ url_for('static', filename='assets/jquery-ui/jquery-ui.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/dist/css/SpeakerCandidateKanban.css') }}">
    <!-- Theme style -->
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/dist/css/AdminLTE.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/dist/css/skins/skin-yellow.min.css') }}">

    <script src="{{ url_for('static', filename='assets/jquery/dist/jquery.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/jquery-ui/jquery-ui.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/dist/js/auth.js') }}"></script>

    
    <title>Speaker Candidates</title>
</head>
<body>
    <div id='kanban-board'>
        <div class='sortable-wrapper'>
            <div>PROSPECTS</div>
            <div class='sortable' id="div-prospect" style="border:1px solid gray; min-height: 600px; max-height: 100%">
                {% for candidate in candidates %}
                {% if(candidate['stage']=="prospect") %}
                    <div class='ui-state-default candidate-item' id='cnd-{{ candidate["id"] }}'>{{ candidate['first_name'] + " " + candidate['last_name']  }}</div>
                {% endif %}
                {% endfor %}
            </div>
            <div>
                <a class="btn btn-success btn-block" id="btn-new-propect">
                    <i class="fa fa-plus-square"></i> New Prospect
                </a>
            </div>
        </div>
        <div class='sortable-wrapper'>
            <div>LEADS</div>
            <div class='sortable' id="div-lead" style="border:1px solid gray; min-height: 600px; max-height: 100%">
                {% for candidate in candidates %}
                {% if(candidate['stage']=="lead") %}
                    <div class='ui-state-default candidate-item' id='cnd-{{ candidate["id"] }}'>{{ candidate['first_name'] + " " + candidate['last_name']  }}</div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        <div class='sortable-wrapper'>
            <div>OFFICIALS</div>
            <div class='sortable' id="div-official" style="border:1px solid gray; min-height: 600px; max-height: 100%">
                {% for candidate in candidates %}
                {% if(candidate['stage']=="official") %}
                    <div class='ui-state-default candidate-item' id='cnd-{{ candidate["id"] }}'>{{ candidate['first_name'] + " " + candidate['last_name']  }}</div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        <button type="button" class="btn btn-warning" id="btn-show-modal" data-toggle="modal" data-target="#modal-candidate" style="display: none">
                Launch Modal
        </button>
    </div>

    {% include "admin/speakers/speaker_candidate_modal.html" ignore missing %}

    <!-- Bootstrap 3.3.7 -->
    <script src="{{ url_for('static', filename='assets/bootstrap/dist/js/bootstrap.min.js') }}"></script>

    <script>

        const updateCandidate = function(id, payload, callback) {
            dsa.request('/api/v1/speaker-candidates/'+id, 'PATCH', payload, function(result) {
                if(!id){
                    callback('id not define, check the ui');
                } else {
                    callback(result);
                }
            });
        }
        
        const showCandidate = function(id, callback) {
            dsa.request('/api/v1/speaker-candidates/'+id, 'GET', null, function(result) {
                if(!id){
                    callback('id not define, check the ui');
                } else {
                    callback(result);
                }
            })
        }

        const createCandidate = function(payload, callback) {
            dsa.request('/api/v1/speaker-candidates', 'POST', payload, function(result) {
                callback(result);
            })
        }
        
        const showModalTab =  function(tabClass) {
            $(".tab1-input").removeClass('active');
            $(".tab2-input").removeClass('active');
            $("."+tabClass).addClass('active');
            if(tabClass=="tab2-input") {
                $("#btn-modal-save1").css('display', 'none');
            } else {
                $("#btn-modal-save1").css('display', '');
            }
            $("#btn-show-modal").click();
        }
        
        const bindDataToModal = function(type, data) {
            if (type=='info') {
                for (var key in data) {
                    $('#data-'+key).val(data[key]);
                }
            } else {

            }
        }

        const clearModalInput = function() {
            $('.input-active').val("");
            $('#log-message').val("");
        }

        const getPayloadFromInputModal = function() {
            var payloads = {};
            $(".input-active").each(function() {
                payloads[$(this).attr("name")] = $(this).val();
            });
            return payloads
        }

        const defineNewLog = function(from, to) {
            var user = dsa.getUser();
            var new_log = "@" + user['username'] + " changed this candidate stage from " + from + " to " + to;
            return new_log;
        }
        
        $(function() {
            var boardWidth = $('#kanban-board').width();
            var $columns = $('.sortable-wrapper');
            var columnCount = $columns.length;
            var columnMargin = 10;
            $columns.width(Math.floor((boardWidth - (columnMargin*(columnCount + 1))) / columnCount));
            
            $( ".sortable" ).sortable({
                revert: true,
                placeholder: 'drag-place-holder',
                forcePlaceholderSize: true, 
                connectWith: ".sortable",
                helper:function(event, element){return $(element).clone().addClass('dragging');},
                start: function (e, ui) {ui.item.show().addClass('ghost')},
                stop: function (e, ui) { ui.item.show().removeClass('ghost')},      
                cursor:'move'
                })
                .disableSelection();
            $(".sortable").droppable({
                drop: function(event, ui) {
                    var stageName = $(this)[0].getAttribute("id").replace('div-', '');
                    var candidateID = ui["draggable"][0].getAttribute("id").replace('cnd-', '');
                    sessionStorage.setItem('candidate_id', candidateID);
                    var payload = {
                        stage: stageName
                    }
                    showCandidate(candidateID, function(result){
                        if(result['meta']['success']) {
                            var candidate = result['data'];
                            var fromStage = result['data']['stage'];
                            updateCandidate(candidateID, payload, function(result){
                                console.log(result);
                                //display logs tab
                                var new_log = defineNewLog(fromStage, stageName);
                                $('#log-message').val(new_log);
                                bindDataToModal('info', candidate);
                                showModalTab('tab2-input');
                            });
                        }
                    })
                }
            });

            /* Candidate Click */
            $(".candidate-item").click(function(event) {
                var candidateID = event.currentTarget.id.replace('cnd-', '');
                sessionStorage.setItem('candidate_id', candidateID);
                // get the candidate infos
                var candidate = {}
                showCandidate(candidateID, function(result) {
                    var result = result['data'];
                    for (var key in result) {
                        candidate[key] = result[key]
                    }
                    clearModalInput();
                    bindDataToModal('info', candidate);
                    // display information tab
                    showModalTab('tab1-input');
                });
            });
            
            /* Tab change event */
            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                var target = $(e.target).attr("href") // activated tab
                if(target=="#tab2-input") {
                    $("#btn-modal-save1").css('display', 'none');
                } else {
                    $("#btn-modal-save1").css('display', '');
                }
            });
            
            /* btn-modal-save1 click */
            $('#btn-modal-save1').click(function() {
                var data = getPayloadFromInputModal();
                var candidateID = sessionStorage.getItem('candidate_id');
                if (candidateID) {
                    updateCandidate(candidateID, data, function(result) {
                        var new_name = [result['data']['first_name'], result['data']['last_name']].join(' ');
                        $('#cnd-'+candidateID).html(new_name);
                    })
                } else {
                    data['stage'] = "prospect";
                    createCandidate(data, function(result) {
                        if(result['meta']['success']) {
                            var new_name = [result['data']['first_name'], result['data']['last_name']].join(' ');
                            var new_id =  result['data']['id'];
                            var new_candidate_item = `<div class='ui-state-default candidate-item' id='cnd-${new_id}'> ${new_name} </div>`
                            $('#div-prospect').append(new_candidate_item);
                        }
                    })
                }
            });

            /* btn-new-propect click */
            $('#btn-new-propect').click(function() {
                // delete candidateID from storage, ad this is  new candidate
                sessionStorage.removeItem('candidate_id');
                clearModalInput();
                $('#data-stage').val('prospect');
                showModalTab('tab1-input');
            })
        });

    </script>
</body>
</html>